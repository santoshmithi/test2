CREATE OR ALTER PROCEDURE dbo.GetBenchmarksWithDynamicExposures
    @First INT = NULL,
    @After NVARCHAR(50) = NULL,
    @RequestedExposures NVARCHAR(MAX) -- JSON: ['Country','Currency','Composition']
AS
BEGIN
    -- Parse requested exposures
    DECLARE @FetchCountry BIT = 0, @FetchCurrency BIT = 0, @FetchComposition BIT = 0;
    
    SELECT 
        @FetchCountry = CASE WHEN EXISTS (SELECT 1 FROM OPENJSON(@RequestedExposures) WHERE value = 'Country') THEN 1 ELSE 0 END,
        @FetchCurrency = CASE WHEN EXISTS (SELECT 1 FROM OPENJSON(@RequestedExposures) WHERE value = 'Currency') THEN 1 ELSE 0 END,
        @FetchComposition = CASE WHEN EXISTS (SELECT 1 FROM OPENJSON(@RequestedExposures) WHERE value = 'Composition') THEN 1 ELSE 0 END;

    -- Get paginated benchmarks
    WITH LatestBenchmarks AS (
        SELECT 
            b.*,
            ROW_NUMBER() OVER (ORDER BY b.IndexSymbol) AS RowNum
        FROM (
            SELECT 
                b.IndexSymbol,
                b.ValueDate,
                b.IndexCurrency,
                b.IndexSource,
                b.MessageGuid,
                ROW_NUMBER() OVER (
                    PARTITION BY b.IndexSymbol 
                    ORDER BY b.ValueDate DESC, b.ExecutedDateTime DESC
                ) AS LatestRow
            FROM Benchmarks b
        ) b
        WHERE b.LatestRow = 1
        AND (@After IS NULL OR b.IndexSymbol > @After)
    )
    
    -- Return benchmark data with requested exposures
    SELECT 
        b.IndexSymbol,
        b.ValueDate,
        b.IndexCurrency,
        b.IndexSource,
        b.MessageGuid,
        -- Country exposure data as JSON array
        CASE WHEN @FetchCountry = 1 THEN 
            (SELECT 
                wa.Country AS country,
                wa.Weight AS weight,
                wa.ExtractedDateTime AS extractedDateTime,
                wa.ImportDate AS importDate
             FROM WeightAllocation wa
             WHERE wa.ParentSymbol = b.IndexSymbol 
             AND wa.ValueDate = b.ValueDate 
             AND wa.Country IS NOT NULL
             ORDER BY wa.Weight DESC  -- Optional: order by weight descending
             FOR JSON PATH)
        ELSE NULL END AS CountryExposure,
        -- Currency exposure data as JSON array
        CASE WHEN @FetchCurrency = 1 THEN 
            (SELECT 
                wa.Currency AS currency,
                wa.Weight AS weight,
                wa.ExtractedDateTime AS extractedDateTime,
                wa.ImportDate AS importDate
             FROM WeightAllocation wa
             WHERE wa.ParentSymbol = b.IndexSymbol 
             AND wa.ValueDate = b.ValueDate 
             AND wa.Currency IS NOT NULL
             ORDER BY wa.Weight DESC  -- Optional: order by weight descending
             FOR JSON PATH)
        ELSE NULL END AS CurrencyExposure,
        -- Composition data as JSON array
        CASE WHEN @FetchComposition = 1 THEN 
            (SELECT 
                c.Sector AS sector,
                c.Industry AS industry,
                c.ExtractedDateTime AS extractedDateTime
             FROM Composition c
             WHERE c.ParentSymbol = b.IndexSymbol 
             AND c.ValueDate = b.ValueDate
             FOR JSON PATH)
        ELSE NULL END AS CompositionExposure
    FROM (
        SELECT * FROM LatestBenchmarks 
        WHERE @First IS NULL OR RowNum <= @First
    ) b
    ORDER BY b.IndexSymbol;
END
